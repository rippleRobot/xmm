<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>Arbitrage</title>

<link href="http://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css"
	rel="stylesheet">

<style>
table {
	table-layout: fixed;
}

.update {
	text-shadow: 0px 0px 1px;
}

.chart {
	height: 240px;
}
</style>

<script src="http://code.jquery.com/jquery.js"></script>
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="node_modules/ripple-lib/build/ripple-0.9.1-min.js"></script>

<script>
var options = {
	max_fee: 12000,
	fee_cushion: 1.2,
	servers: [
		"wss://s-east.ripple.com:443",
		"wss://s-west.ripple.com:443"
	],
	trusted: false
};
var remote = new ripple.Remote(options);
var id = location.search.replace("?", "");
var account = remote.account(id);
var pairs = {};
var paths = {};
var units = {};
var template = {};
var pending = true;
var ready = false;
var ledger, saldo, table, header, state, ws;

function start()
{
	var target;

	for (target in ws)
		ws[target].disconnect();

	ws = {};

	state.addClass("info");
	remote.once("ledger_closed", getsaldo);
}

function getsaldo(data)
{
	ledger = data.ledger_index;
	if (!ledger) {
		console.error("Failed to get ledger");
		return start();
	}

	remote.request_account_balance(id, ledger, setxrp);
}

function setxrp(error, response)
{
	if (error) {
		console.error("Failed to get balance");
		return start();
	}

	saldo = {};

	saldo["XRP"] = response.to_number() / 1e6;

	find(response.divide(2).to_json());

	remote.request_account_lines(id, ledger, setlines);
}

function setlines(error, response)
{
	var lines, i, unit;

	if (error) {
		console.error("Failed to get lines");
		return start();
	}

	lines = response.lines;
	for (i = 0; i < lines.length; i++) {
		var line = lines[i];
		var balance = parseFloat(line.balance);
		var active = line.no_ripple;
		var currency = line.currency;
		var account = line.account;

		if (active) {
			if (saldo[currency])
				saldo[currency] += balance;
			else
				saldo[currency] = balance;
		}
	}

	show();
}

function pay(path, key)
{
	var tx = remote.transaction();

	tx.payment(id, id, path.amount);
	tx.paths(path.alt);
	tx.sendMax(path.cost);
	tx.set_flags("PartialPayment");
	tx.secret(key);

	return tx;
}

function trade()
{
	var cell = $(this);
	var pair = cell.data("pair");
	var riap = pair.split(">").reverse().join(">");
	var path = paths[pair];
	var back = paths[riap];
	var key = prompt([
		cell.text(),
		pairs[riap].text()
	].join("\n"));
	var buy = pay(path, key);
	var sell = pay(back, key);

	function log(error, response)
	{
		console.log(error, response);
	}

	if (!key)
		return;

	buy.submit(log);
	sell.submit(log);
}

function addunit(unit)
{
	var src, dst;

	if (units[unit])
		return;

	src = template.row.clone();
	dst = template.header.clone();
	dst.text(unit);
	header.append(dst);
	src.append(dst.clone());
	table.append(src);

	for (dst in units) {
		var cell = template.cell.clone();
		var pair = unit + ">" + dst;

		src.append(cell);
		pairs[pair] = cell;

		if (unit != dst) {
			cell.data("pair", pair);
			cell.click(trade);
		}
	}

	units[unit] = src;
	for (src in units) {
		var cell = template.cell.clone();
		var pair = src + ">" + unit;

		units[src].append(cell);
		pairs[pair] = cell;

		if (unit != src) {
			cell.data("pair", pair);
			cell.click(trade);
		}
	}
}

function appear()
{
	var cell = $(this);

	cell.removeClass();
	cell.addClass(cell.data("class"));
	cell.text(cell.data("update"));
	cell.fadeIn();
}

function replace(cell)
{
	var src = cell.text();
	var dst = cell.data("update");

	if (src == dst)
		return;

	if (src)
		cell.addClass("update").delay(2e3).fadeOut(appear);
	else
		appear.call(cell);
}

function show()
{
	var date = new Date();
	var unit;

	for (unit in saldo) {
		var balance = saldo[unit];
		var cell, prev, change;

		addunit(unit);

		cell = pairs[unit + ">" + unit];
		prev = parseFloat(cell.data("balance"));

		if (balance == prev)
			continue;

		cell.data("balance", balance);

		if (prev < balance) {
			cell.data("class", "text-success");
			change = "\u25B2";
		} else if (balance < prev) {
			cell.data("class", "text-danger");
			change = "\u25BC";
		} else {
			cell.data("class", "text-warning");
			change = "\u25CF";
		}

		cell.data("update", change + " " + balance.toPrecision(6));
		replace(cell);
	}

	state.removeClass();
	state.data("time", date.getTime());
	table.removeClass("hidden");
	listen();
}

function request()
{
	if (!ready) {
		pending = true;
		return;
	}

	ready = false;
	pending = false;
	start();
}

function convert(amount)
{
	var dict = {};

	function getunit(amount)
	{
		if ("object" == typeof amount)
			return amount.currency;
		else
			return "XRP";
	}

	function getvalue(amount)
	{
		if ("object" == typeof amount)
			return parseFloat(amount.value);
		else
			return parseFloat(amount) / 1e6;
	}

	dict.currency = getunit(amount);
	dict.value = getvalue(amount);
	return dict;
}

function getprice(src, dst)
{
	var base = src.currency;
	var counter = dst.currency;
	var price, unit;

	src = src.value;
	dst = dst.value;

	if (src < dst) {
		price = dst / src;
		unit = counter + "/" + base;
	} else {
		price = src / dst;
		unit = base + "/" + counter;
	}

	return price.toPrecision(6) + " " + unit;
}

function display()
{
	var date = new Date();
	var pair;

	for (pair in paths) {
		var riap = pair.split(">").reverse().join(">");
		var back = paths[riap];
		var path = paths[pair];
		var cell = pairs[pair];

		if (back) {
			var p0 = path.price;
			var p1 = back.price;
			var profit = p0 * p1 - 1;
			var time = Math.min(path.time, back.time);
			var since = date.getTime() - time;

			cell.removeClass();
			if (5e3 < since)
				cell.addClass("warning");
			else if (0 < profit)
				cell.addClass("success");
			else
				cell.addClass("danger");

			profit *= 100;
			profit = "(" + profit.toFixed(1) + "%)";
			cell.text(path.human + " " + profit);
		}
	}
}

function update(data)
{
	var date = new Date();
	var alt = data.alternatives;
	var amount = data.destination_amount;
	var dst = convert(amount);
	var n = alt.length;
	var i;

	for (i = 0; i < n; i++) {
		var path = alt[i];
		var cost = path.source_amount;
		var src = convert(cost);
		var pair = src.currency + ">" + dst.currency;

		if (pairs[pair]) {
			paths[pair] = {
				alt: path.paths_computed,
				human: getprice(src, dst),
				price: dst.value / src.value,
				time: date.getTime(),
				cost: cost,
				amount: amount
			};

			if ("XRP" == dst.currency)
				find(cost);
		}
	}

	display();
}

function setup()
{
	var dst = ripple.Amount.from_json(this.dst);
	var path = this.pathFind(id, id, dst);

	path.on("update", update);
}

function find(dst)
{
	var target = convert(dst).currency;
	var socket = ws[target];

	if (socket)
		return;

	socket = new ripple.Remote(options);
	socket.dst = dst;
	socket.connect(setup);
	ws[target] = socket;
}

function listen()
{
	ready = true;

	if (pending)
		request();
}

function tick()
{
	var date = new Date();
	var last = state.data("time");

	if (last) {
		var since = date.getTime() - last;

		since = new Date(since);
		since = since.toISOString();
		since = since.replace(/^.*T(..:..:..).*$/, "$1");
		state.text(since);
	}

	display();
}

function getstats(list)
{
	var fields = list.shift();
	var nfields = fields.length;
	var n = list.length;
	var stats = {};
	var data = [];
	var format = "{point.name}: {point.percentage:.1f}%";
	var i, j, pair;

	for (i = 0; i < n; i++) {
		var entry = list[i];
		var dict = {};

		for (j = 0; j < nfields; j++) {
			var name = fields[j];

			dict[name] = entry[j];
		}

		list[i] = dict;

		pair = [
			dict.baseCurrency,
			dict.counterCurrency
		].sort().join("/");

		if (stats[pair])
			++stats[pair];
		else
			stats[pair] = 1;
	}

	for (pair in stats) {
		var part = 100 * stats[pair] / n;
		var entry = [
			pair,
			part
		];

		if (1 < part)
			data.unshift(entry);
	}

	$("div.chart").highcharts({
		title: null,
		tooltip: {
			enabled: false
		},
		plotOptions: {
			pie: {
				allowPointSelect: true,
				dataLabels: {
					format: format,
					style: {
						fontWeight: "bold"
					}
				},
				innerSize: "50%",
				size: "100%"
			}
		},
		series: [{
			type: "pie",
			data: data
		}]
	});
}

function main()
{
	var old = new Date(0);
	var now = new Date();

	$("h1").text(id);

	table = $("table");
	header = $("tr");
	state = $("td");
	state.click(request);

	template.header = header.children("th").detach();
	template.row = header.clone();
	template.cell = template.row.children("td").detach();

	setInterval(tick, 1e3);
	account.on("transaction", request);
	remote.connect(listen);

	$.post("http://api.ripplecharts.com/api/account_offers_exercised", {
		descending: true,
		startTime: old.toISOString(),
		endTime: now.toISOString(),
		account: id
	}, getstats);
}

$(main);
</script>
</head>

<body>
<div class="container-fluid">
<div class="chart page-header"></div>

<table class="table table-bordered text-center hidden">
<tr>
<td></td>
<th class="text-center">XRP</th>
</tr>
</table>
</div>
</body>
</html>
