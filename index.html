<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>Statistics</title>

<link href="http://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css"
	rel="stylesheet">

<style>
.chart {
	height: 480px
}
</style>

<script src="http://code.jquery.com/jquery.js"></script>
<script src="http://code.highcharts.com/stock/highstock.js"></script>

<script>
var assets = {};
var series = [];
var table, template, log, cutoff, from, key, fresh, since;

function interest(entry)
{
	var src = log[cutoff];
	var dst = log[entry];
	var year = 60 * 24 * 365.25;
	var ratio, period;

	if (cutoff == entry)
		return 0;

	ratio = dst.value / src.value;
	period = dst.time - src.time;
	return Math.pow(ratio, year / period) - 1;
}

function growth(src, dst)
{
	var k = 1;
	var p0 = src.prices;
	var p1 = dst.prices;
	var unit;

	for (unit in p1) {
		var prev = p0[unit];
		var last = p1[unit];

		if (prev)
			k *= last / prev;
	}

	return k;
}

function addrow(entry)
{
	var row = template.clone();
	var children = row.children();

	function fill()
	{
		var field = $(this).attr("headers");
		var datum = entry[field];

		if (datum)
			$(this).text(datum);
	}

	children.each(fill);
	table.prepend(row);

	fresh = fresh.add(row);
}

function addasset(unit)
{
	var i = assets[unit];

	if (i)
		return i;

	i = series.length;

	series.push({
		yAxis: 0,
		name: unit,
		type: "spline",
		marker: {
			enabled: true,
			radius: 3
		},
		tooltip: {
			valueDecimals: 3
		},
		data: []
	});

	assets[unit] = i;
	return i;
}

function addpoint(time, entry)
{
	var dict = entry.prices;
	var unit;

	series[0].data.push([time, entry.growth]);

	for (unit in dict) {
		var price = dict[unit];
		var i = addasset(unit);

		series[i].data.push([time, 1 / price]);
	}
}

function zoom(range)
{
	localStorage[key + ">"] = JSON.stringify(range.min);
}

function load(data)
{
	var chart = $("div.chart");
	var date = new Date();
	var timezone = date.getTimezoneOffset();
	var i;

	log = data;

	cutoff = location.search;
	cutoff = cutoff.replace("?cutoff=", "");
	cutoff = parseInt(cutoff);
	if (!cutoff)
		cutoff = 0;

	series.push({
		yAxis: 1,
		name: $("th#growth").text(),
		type: "column",
		tooltip: {
			valueDecimals: 2,
			valueSuffix: "\u2031"
		},
		data: []
	});

	if (log.length)
		log[cutoff].value = 100;

	for (i = cutoff; i < log.length; i++) {
		var prev = log[cutoff == i ? i : i - 1];
		var last = log[i];
		var time = last.time;

		last.value = prev.value * growth(prev, last);
		last.date = new Date(last.time);
		last.time /= 6e4;
		last.interest = 100 * interest(i);
		last.since = last.time - prev.time;
		last.growth = 100 * (last.value - prev.value);

		addpoint(time, last);

		if (i < from)
			continue;

		addrow({
			index: i.toFixed(0),
			seq: last.seq.toFixed(0),
			iou: last.iou.toFixed(3),
			growth: last.growth.toFixed(2) + "\u2031",
			since: last.since.toFixed(0) + " min",
			value: last.value.toFixed(2) + "%",
			date: last.date.toLocaleDateString(),
			time: last.date.toLocaleTimeString(),
			interest: last.interest.toFixed(2) + "%"
		});
	}

	localStorage[key] = JSON.stringify({
		html: table.html(),
		from: log.length
	});
	fresh.addClass("info");

	Highcharts.setOptions({
		global: {
			timezoneOffset: timezone
		}
	});
	chart.highcharts("StockChart", {
		colors: [
			"maroon",
			"red",
			"gold",
			"lime",
			"blue",
			"fuchsia"
		],
		tooltip: {
			animation: false,
			hideDelay: 0
		},
		plotOptions: {
			series: {
				dataGrouping: {
					smoothed: true,
					forced: true
				}
			},
			spline: {
				compare: "percent"
			},
			column: {
				color: "tan"
			}
		},
		xAxis: {
			labels: {
				style: {
					fontWeight: "bold"
				}
			},
			events: {
				afterSetExtremes: zoom
			},
			minTickInterval: 6e4,
			ordinal: false
		},
		chart: {
			spacingTop: 0,
			spacingRight: 1,
			spacingLeft: 1,
			zoomType: "x",
			animation: false
		},
		yAxis: [{
			labels: {
				style: {
					fontWeight: "bold"
				},
				format: "{value}%",
				align: "right",
				x: 0
			},
			minorTickInterval: "auto"
		}, {
			labels: {
				format: "{value}\u2031",
				style: {
					fontWeight: "bold"
				},
				align: "left",
				x: 0
			},
			opposite: false,
			gridLineWidth: 0,
			offset: 0
		}],
		rangeSelector: {
			inputEnabled: false,
			buttons: [{
				type: "hour",
				count: 3,
				text: "3h"
			}, {
				type: "hour",
				count: 8,
				text: "8h"
			}, {
				type: "day",
				count: 1,
				text: "1d"
			}, {
				type: "day",
				count: 3,
				text: "3d"
			}, {
				type: "week",
				count: 1,
				text: "1w"
			}, {
				type: "month",
				count: 1,
				text: "1m"
			}, {
				type: "month",
				count: 3,
				text: "3m"
			}, {
				type: "all",
				text: "All"
			}]
		},
		navigator: {
			enabled: false
		},
		series: series
	});
	chart.highcharts().xAxis[0].setExtremes(since);
}

function main()
{
	var date = new Date();
	var html;

	table = $("tbody");
	fresh = $("tr.template");
	template = fresh.detach();
	template.removeClass("template");

	key = location.href;

	since = parseFloat(localStorage[key + ">"]);
	if (!since)
		since = undefined;

	try {
		var cache = JSON.parse(localStorage[key]);

		html = cache.html;
		from = cache.from;
	} catch (error) {
		html = "";
		from = 0;
	}

	table.html(html);

	$.getJSON("history.json", load);
}

$(main);
</script>
</head>

<body>
<div class="container-fluid">
<div class="chart page-header"></div>

<table class="table table-striped table-bordered text-right">
<thead>
<tr>
<th id="index">Index</th>
<th id="seq">Sequence</th>
<th id="iou">Shares</th>
<th id="date">Date</th>
<th id="time">Time</th>
<th id="since">Passed</th>
<th id="growth">Growth</th>
<th id="value">Value</th>
<th id="interest">Annual</th>
</tr>
</thead>

<tbody>
<tr class="template">
<td headers="index"></td>
<td headers="seq"></td>
<td headers="iou"></td>
<td headers="date"></td>
<td headers="time"></td>
<td headers="since"></td>
<td headers="growth"></td>
<td headers="value"></td>
<td headers="interest"></td>
</tr>
</tbody>
</table>
</div>
</body>
</html>
