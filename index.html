<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>Statistics</title>

<link href="http://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.css"
	rel="stylesheet">

<script src="http://code.jquery.com/jquery.js"></script>

<script>
var table, template, log;

function interest(entry)
{
	var src = log[0];
	var dst = log[entry];
	var year = 60 * 24 * 365.25;
	var ratio, period;

	if (!src || !dst || !entry)
		return 0;

	ratio = dst.value / src.value;
	period = dst.time - src.time;
	return Math.pow(ratio, year / period) - 1;
}

function nassets(saldo)
{
	var n = 0;
	var unit;

	for (unit in saldo)
		if (0 < saldo[unit])
			++n;

	return n;
}

function growth(src, dst)
{
	var n = 0;
	var k = 1;
	var n0 = src.nassets;
	var n1 = dst.nassets;
	var unit, iou0, iou1;

	src = src.saldo;
	dst = dst.saldo;

	for (unit in dst) {
		var prev = src[unit];
		var balance = dst[unit];

		if (!balance || !prev)
			continue;

		if (0 < balance) {
			k *= balance / prev;
			++n;
		} else {
			iou0 = -prev / n0;
			iou1 = -balance / n1;
		}
	}

	return k / Math.pow(iou1 / iou0, n);
}

function addrow(entry)
{
	var row = template.clone();
	var children = row.children();

	function fill()
	{
		var field = $(this).attr("headers");
		var datum = entry[field];

		if (datum)
			$(this).text(datum);
	}

	children.each(fill);
	table.prepend(row);
}

function load(data)
{
	var i;

	log = data;

	if (log.length)
		log[0].value = 100;

	table = $("tbody");
	template = $("tr.template").detach();
	template.removeClass("template");

	for (i = 0; i < log.length; i++) {
		var prev = log[i - 1];
		var last = log[i];
		var time = last.time;
		var saldo = last.saldo;

		if (!prev)
			prev = last;

		last.nassets = nassets(saldo);
		last.value = prev.value * growth(prev, last);
		last.date = new Date(last.time);
		last.time /= 6e4;
		last.interest = 100 * interest(i);
		last.since = last.time - prev.time;
		last.growth = 100 * (last.value - prev.value);

		addrow({
			index: i.toFixed(0),
			seq: last.seq.toFixed(0),
			growth: last.growth.toFixed(2) + "\u2031",
			since: last.since.toFixed(0) + " min",
			value: last.value.toFixed(2) + "%",
			date: last.date.toLocaleDateString(),
			time: last.date.toLocaleTimeString(),
			interest: last.interest.toFixed(2) + "%"
		});
	}
}

function main()
{
	$.getJSON("history.json", load);
}

$(main);
</script>
</head>

<body>
<div class="container-fluid">
<div class="page-header"></div>

<table class="table table-striped table-bordered text-right">
<thead>
<tr>
<th id="index">#</th>
<th id="seq">Sequence</th>
<th id="date">Date</th>
<th id="time">Time</th>
<th id="since">Passed</th>
<th id="growth">Growth</th>
<th id="value">Value</th>
<th id="interest">Annual</th>
</tr>
</thead>

<tbody>
<tr class="template">
<td headers="index"></td>
<td headers="seq"></td>
<td headers="date"></td>
<td headers="time"></td>
<td headers="since"></td>
<td headers="growth"></td>
<td headers="value"></td>
<td headers="interest"></td>
</tr>
</tbody>
</table>
</div>
</body>
</html>
